#!/bin/sh
set -e
### BEGIN INIT INFO
# Provides: bamboo
# Required-Start: $local_fs $remote_fs $network $time
# Required-Stop: $local_fs $remote_fs $network $time
# Should-Start: $syslog
# Should-Stop: $syslog
# Default-Start: 2 3 4 5
# Default-Stop: 0 1 6
# Short-Description: Atlassian Bamboo Server
### END INIT INFO
# INIT Script
######################################

# Define some variables
# Name of service ( bamboo, confluence, etc )
SERVICE=<%= @service_name %>
# Name of the user to run as
USER=<%= @bamboo_user %>
# Location of application's bin directory
BASE=<%= @install_dir %>/current
# Process lock file
LOCKFILE=/var/lock/subsys/<%= @service_name %>
# JAVA HOME
JAVA_HOME=<%= @java_home %>

function start() {
  echo -n $"Starting $SERVICE: "
  /bin/su - $USER -c "export BAMBOO_HOME=${BAMBOO_HOME}; $BASE/bin/startup.sh &> /dev/null"
  RETVAL=$?
  echo

  # If everything is okay touch the lock file
  [ $RETVAL -eq 0 ] && touch $LOCKFILE
  return $RETVAL
}

function stop() {
  echo -n $"Shutting down $SERVICE: "
  /bin/su - $USER -c "$BASE/bin/shutdown.sh &> /dev/null"
  RETVAL=$?
  echo

  # If everything is okay remove the lockfile
  [ $RETVAL -eq 0 ] && rm -f $lockfile
  return $RETVAL
}

function status() {
  STATUS=$( ps aux | grep "[c]atalina.base=$BASE" | wc -l )
  if [ $STATUS -gt 0 ];then
    ps -ef |grep $SERVICE |grep -v grep |awk '{ print $2 }' | $JAVA_HOME/bin/jps |grep -v Jps |grep -v grep > /dev/null
    RETVAL=$?
    if [ $RETVAL -eq 0 ];then
      echo "$SERVICE is running"
      return $RETVAL
    else
      echo "$SERVICE is stopped"
      return $RETVAL
    fi
  else
    echo "$SERVICE is stopped"
    return 1
  fi
}

case "$1" in
  # Start command
  start)
    start
    ;;
  # Stop command
  stop)
    stop
    ;;
  # Status command
  status)
    status
    ;;
  # Restart command
  restart)
    stop
    sleep 5
    start
    ;;
  *)
    echo "Usage: /etc/init.d/$SERVICE {start|stop|status|restart}"
    exit 1
    ;;
esac

exit 0
